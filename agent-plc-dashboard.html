<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Agent Deployment Dashboard - AI Grid Link</title>
  
  <style>
    :root {
      --bg: #050711;
      --bg-panel: #0b0f1f;
      --accent: #4fd1c5;
      --accent-soft: rgba(79, 209, 197, 0.2);
      --danger: #f56565;
      --warn: #ecc94b;
      --ok: #48bb78;
      --text: #e2e8f0;
      --muted: #718096;
      --border: #1a202c;
    }
    
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: radial-gradient(circle at top, #111827 0, #050711 55%);
      color: var(--text);
      padding: 20px;
      min-height: 100vh;
    }
    
    .header {
      text-align: center;
      margin-bottom: 30px;
    }
    
    .header h1 {
      font-size: 2rem;
      color: var(--accent);
      margin-bottom: 10px;
      text-transform: uppercase;
      letter-spacing: 0.1em;
    }
    
    .header p {
      color: var(--muted);
      font-size: 0.9rem;
    }
    
    .nav-links {
      text-align: center;
      margin-bottom: 20px;
    }
    
    .nav-links a {
      color: var(--accent);
      text-decoration: none;
      margin: 0 15px;
      padding: 8px 16px;
      border: 1px solid var(--accent);
      border-radius: 6px;
      transition: all 0.3s;
    }
    
    .nav-links a:hover {
      background: var(--accent-soft);
    }
    
    .dashboard-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }
    
    .agent-card {
      background: linear-gradient(135deg, var(--bg-panel) 0%, rgba(15, 23, 42, 0.8) 100%);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
    }
    
    .agent-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
      padding-bottom: 15px;
      border-bottom: 1px solid var(--border);
    }
    
    .agent-title {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .agent-icon {
      font-size: 2rem;
    }
    
    .agent-name {
      font-size: 1.1rem;
      font-weight: 600;
      color: var(--accent);
    }
    
    .agent-status {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 4px 12px;
      border-radius: 999px;
      font-size: 0.75rem;
      font-weight: 600;
      text-transform: uppercase;
    }
    
    .agent-status.healthy {
      background: rgba(72, 187, 120, 0.2);
      color: var(--ok);
      border: 1px solid var(--ok);
    }
    
    .agent-status.initializing {
      background: rgba(236, 201, 75, 0.2);
      color: var(--warn);
      border: 1px solid var(--warn);
    }
    
    .agent-status.error {
      background: rgba(245, 101, 101, 0.2);
      color: var(--danger);
      border: 1px solid var(--danger);
    }
    
    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      animation: pulse 2s infinite;
    }
    
    .healthy .status-dot {
      background: var(--ok);
    }
    
    .initializing .status-dot {
      background: var(--warn);
    }
    
    .error .status-dot {
      background: var(--danger);
    }
    
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }
    
    .agent-metrics {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 10px;
      margin-bottom: 15px;
    }
    
    .metric {
      background: rgba(255, 255, 255, 0.03);
      padding: 10px;
      border-radius: 6px;
      border: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    .metric-label {
      font-size: 0.7rem;
      color: var(--muted);
      text-transform: uppercase;
      margin-bottom: 4px;
    }
    
    .metric-value {
      font-size: 1.2rem;
      font-weight: 600;
      color: var(--text);
    }
    
    .agent-actions {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }
    
    .btn {
      flex: 1;
      min-width: 80px;
      padding: 8px 12px;
      border: none;
      border-radius: 6px;
      font-size: 0.75rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      text-transform: uppercase;
    }
    
    .btn-primary {
      background: var(--accent);
      color: var(--bg);
    }
    
    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px var(--accent-soft);
    }
    
    .btn-secondary {
      background: rgba(255, 255, 255, 0.1);
      color: var(--text);
      border: 1px solid rgba(255, 255, 255, 0.2);
    }
    
    .btn-secondary:hover {
      background: rgba(255, 255, 255, 0.15);
    }
    
    .section {
      background: linear-gradient(135deg, var(--bg-panel) 0%, rgba(15, 23, 42, 0.8) 100%);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
    }
    
    .section-title {
      font-size: 1.3rem;
      color: var(--accent);
      margin-bottom: 15px;
      padding-bottom: 10px;
      border-bottom: 1px solid var(--border);
    }
    
    .device-list {
      max-height: 400px;
      overflow-y: auto;
    }
    
    .device-item {
      background: rgba(255, 255, 255, 0.03);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 6px;
      padding: 12px;
      margin-bottom: 8px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .device-info {
      flex: 1;
    }
    
    .device-name {
      font-weight: 600;
      color: var(--text);
      margin-bottom: 4px;
    }
    
    .device-type {
      font-size: 0.8rem;
      color: var(--muted);
    }
    
    .device-confidence {
      font-size: 0.9rem;
      font-weight: 600;
      padding: 4px 10px;
      border-radius: 999px;
      background: rgba(79, 209, 197, 0.2);
      color: var(--accent);
    }
    
    .script-history {
      max-height: 400px;
      overflow-y: auto;
    }
    
    .script-item {
      background: rgba(255, 255, 255, 0.03);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 6px;
      padding: 12px;
      margin-bottom: 8px;
    }
    
    .script-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }
    
    .script-id {
      font-family: monospace;
      font-size: 0.8rem;
      color: var(--muted);
    }
    
    .script-status {
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 0.7rem;
      font-weight: 600;
    }
    
    .script-status.completed {
      background: rgba(72, 187, 120, 0.2);
      color: var(--ok);
    }
    
    .script-status.failed {
      background: rgba(245, 101, 101, 0.2);
      color: var(--danger);
    }
    
    .script-details {
      font-size: 0.8rem;
      color: var(--muted);
    }
    
    .script-injection-form {
      display: grid;
      gap: 12px;
    }
    
    .form-group {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }
    
    .form-label {
      font-size: 0.8rem;
      color: var(--muted);
      text-transform: uppercase;
      font-weight: 600;
    }
    
    .form-input,
    .form-select,
    .form-textarea {
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 6px;
      padding: 10px;
      color: var(--text);
      font-size: 0.9rem;
      font-family: inherit;
    }
    
    .form-textarea {
      min-height: 100px;
      font-family: monospace;
      resize: vertical;
    }
    
    .form-input:focus,
    .form-select:focus,
    .form-textarea:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 2px var(--accent-soft);
    }
    
    .empty-state {
      text-align: center;
      padding: 40px;
      color: var(--muted);
    }
    
    .empty-state-icon {
      font-size: 3rem;
      margin-bottom: 10px;
      opacity: 0.5;
    }
    
    /* Scrollbar styling */
    ::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }
    
    ::-webkit-scrollbar-track {
      background: rgba(255, 255, 255, 0.05);
      border-radius: 4px;
    }
    
    ::-webkit-scrollbar-thumb {
      background: var(--accent-soft);
      border-radius: 4px;
    }
    
    ::-webkit-scrollbar-thumb:hover {
      background: var(--accent);
    }
    
    @media (max-width: 768px) {
      .dashboard-grid {
        grid-template-columns: 1fr;
      }
      
      .agent-metrics {
        grid-template-columns: 1fr;
      }
    }
  </style>
  
  <!-- Load agent scripts -->
  <script src="/powerline-communication.js"></script>
  <script src="/src/agents/mobile-power-grid-agent.js"></script>
  <script src="/src/agents/device-identification-agent.js"></script>
  <script src="/src/agents/echo-script-injection-agent.js"></script>
    <link rel="stylesheet" href="/css/universal-styles.css">
</head>
<body>
  <div class="header">
    <h1>‚ö° Agent Deployment Dashboard</h1>
    <p>Monitor and control AI Grid Link enhancement agents</p>
  </div>
  
  <div class="nav-links">
    <a href="aiGridLink.html">‚Üê Back to Grid Console</a>
    <a href="#" onclick="refreshDashboard(); return false;">üîÑ Refresh</a>
  </div>
  
  <!-- Agent Health Cards -->
  <div class="dashboard-grid" id="agent-cards">
    <!-- Agent cards will be populated by JavaScript -->
  </div>
  
  <!-- Device Identification Results -->
  <div class="section">
    <h2 class="section-title">üîç Device Identification Results</h2>
    <div class="device-list" id="device-list">
      <div class="empty-state">
        <div class="empty-state-icon">üîç</div>
        <p>No devices identified yet. Waiting for device discovery...</p>
      </div>
    </div>
  </div>
  
  <!-- Echo Script Execution History -->
  <div class="section">
    <h2 class="section-title">üìú Echo Script Execution History</h2>
    <div class="script-history" id="script-history">
      <div class="empty-state">
        <div class="empty-state-icon">üìú</div>
        <p>No scripts executed yet.</p>
      </div>
    </div>
  </div>
  
  <!-- Manual Script Injection -->
  <div class="section">
    <h2 class="section-title">üíâ Manual Script Injection</h2>
    <form class="script-injection-form" id="script-form" onsubmit="injectScript(event)">
      <div class="form-group">
        <label class="form-label">Device ID</label>
        <select class="form-select" id="device-select" required>
          <option value="">Select a device...</option>
        </select>
      </div>
      
      <div class="form-group">
        <label class="form-label">Command Type</label>
        <select class="form-select" id="command-type" required>
          <option value="">Select command type...</option>
        </select>
      </div>
      
      <div class="form-group">
        <label class="form-label">Script</label>
        <textarea class="form-textarea" id="script-content" placeholder="Enter script commands..." required></textarea>
      </div>
      
      <div class="form-group">
        <label>
          <input type="checkbox" id="force-execute">
          Force execute (ignore warnings)
        </label>
      </div>
      
      <button type="submit" class="btn btn-primary">üíâ Inject Script</button>
    </form>
  </div>
  
  <script>
    // Global agent references
    let agents = {
      mobilePower: null,
      deviceIdent: null,
      echoScript: null
    };
    
    // Initialize dashboard
    function initDashboard() {
      console.log('[Dashboard] Initializing...');
      
      // Wait for agents to be available
      const checkAgents = setInterval(() => {
        if (window.mobilePowerAgent && window.deviceIdentAgent && window.echoScriptAgent) {
          clearInterval(checkAgents);
          
          agents.mobilePower = window.mobilePowerAgent;
          agents.deviceIdent = window.deviceIdentAgent;
          agents.echoScript = window.echoScriptAgent;
          
          setupAgentListeners();
          renderAgentCards();
          updateDeviceList();
          updateScriptHistory();
          populateFormOptions();
          
          // Auto-refresh every 5 seconds
          setInterval(() => {
            renderAgentCards();
            updateDeviceList();
            updateScriptHistory();
          }, 5000);
          
          console.log('[Dashboard] ‚úì Initialized');
        }
      }, 100);
    }
    
    // Set up agent event listeners
    function setupAgentListeners() {
      // Mobile Power Agent
      agents.mobilePower.on('source-changed', (data) => {
        console.log('[Dashboard] Power source changed:', data);
        renderAgentCards();
      });
      
      // Device Identification Agent
      agents.deviceIdent.on('device-identified', (data) => {
        console.log('[Dashboard] Device identified:', data);
        updateDeviceList();
      });
      
      // Echo Script Agent
      agents.echoScript.on('script-completed', (data) => {
        console.log('[Dashboard] Script completed:', data);
        updateScriptHistory();
      });
      
      agents.echoScript.on('script-failed', (data) => {
        console.log('[Dashboard] Script failed:', data);
        updateScriptHistory();
      });
    }
    
    // Render agent health cards
    function renderAgentCards() {
      const container = document.getElementById('agent-cards');
      
      const agentConfigs = [
        {
          name: 'Mobile Power Grid Agent',
          icon: 'üîã',
          agent: agents.mobilePower,
          metrics: (health, status) => ({
            'Battery API': health.batteryAPIAvailable ? 'Available' : 'N/A',
            'Current Source': status.source || 'Unknown',
            'Data Source': status.dataSource || 'Unknown',
            'Monitoring': health.monitoring ? 'Active' : 'Inactive'
          })
        },
        {
          name: 'Device Identification Agent',
          icon: 'üîç',
          agent: agents.deviceIdent,
          metrics: (health, results) => ({
            'Device Types': health.deviceTypesKnown || 0,
            'Identified': results.identified?.length || 0,
            'Unknown': results.unknown?.length || 0,
            'Learning Mode': health.learningMode ? 'On' : 'Off'
          })
        },
        {
          name: 'Echo Script Injection Agent',
          icon: 'üíâ',
          agent: agents.echoScript,
          metrics: (health, queue) => ({
            'Queue Length': queue.queueLength || 0,
            'Processing': queue.processing || 0,
            'Command Types': health.commandTypes || 0,
            'Safety Check': health.safetyValidation ? 'Enabled' : 'Disabled'
          })
        }
      ];
      
      const html = agentConfigs.map(config => {
        const health = config.agent.getHealth();
        const status = config.agent.getBatteryStatus ? config.agent.getBatteryStatus() :
                      config.agent.getIdentificationResults ? config.agent.getIdentificationResults() :
                      config.agent.getQueueStatus ? config.agent.getQueueStatus() : {};
        
        const statusClass = health.status === 'healthy' ? 'healthy' : 
                           health.status === 'initializing' ? 'initializing' : 'error';
        
        const metrics = config.metrics(health, status);
        const metricsHtml = Object.entries(metrics).map(([label, value]) => `
          <div class="metric">
            <div class="metric-label">${label}</div>
            <div class="metric-value">${value}</div>
          </div>
        `).join('');
        
        return `
          <div class="agent-card">
            <div class="agent-header">
              <div class="agent-title">
                <span class="agent-icon">${config.icon}</span>
                <div>
                  <div class="agent-name">${config.name}</div>
                </div>
              </div>
              <div class="agent-status ${statusClass}">
                <div class="status-dot"></div>
                ${health.status}
              </div>
            </div>
            
            <div class="agent-metrics">
              ${metricsHtml}
            </div>
            
            <div class="agent-actions">
              <button class="btn btn-secondary" onclick="viewAgentDetails('${config.name}')">Details</button>
              <button class="btn btn-primary" onclick="restartAgent('${config.name}')">Restart</button>
            </div>
          </div>
        `;
      }).join('');
      
      container.innerHTML = html;
    }
    
    // Update device identification list
    function updateDeviceList() {
      const container = document.getElementById('device-list');
      const results = agents.deviceIdent.getIdentificationResults();
      
      if (results.identified.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">üîç</div>
            <p>No devices identified yet. Waiting for device discovery...</p>
          </div>
        `;
        return;
      }
      
      const html = results.identified.map(item => {
        const confidence = (item.confidence * 100).toFixed(1);
        return `
          <div class="device-item">
            <div class="device-info">
              <div class="device-name">
                ${item.type.icon} ${item.deviceName}
              </div>
              <div class="device-type">
                Identified as: ${item.type.name}
              </div>
            </div>
            <div class="device-confidence">
              ${confidence}%
            </div>
          </div>
        `;
      }).join('');
      
      container.innerHTML = html;
    }
    
    // Update script execution history
    function updateScriptHistory() {
      const container = document.getElementById('script-history');
      const history = agents.echoScript.getExecutionHistory(20);
      
      if (history.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">üìú</div>
            <p>No scripts executed yet.</p>
          </div>
        `;
        return;
      }
      
      const html = history.map(script => {
        const statusClass = script.status === 'completed' ? 'completed' : 'failed';
        const time = script.executionTime ? `${script.executionTime}ms` : 'N/A';
        
        return `
          <div class="script-item">
            <div class="script-header">
              <div class="script-id">${script.id}</div>
              <div class="script-status ${statusClass}">${script.status}</div>
            </div>
            <div class="script-details">
              <div><strong>Device:</strong> ${script.deviceId}</div>
              <div><strong>Type:</strong> ${script.commandType}</div>
              <div><strong>Time:</strong> ${time}</div>
              ${script.error ? `<div style="color: var(--danger);"><strong>Error:</strong> ${script.error}</div>` : ''}
            </div>
          </div>
        `;
      }).join('');
      
      container.innerHTML = html;
    }
    
    // Populate form options
    function populateFormOptions() {
      // Populate device select
      const deviceSelect = document.getElementById('device-select');
      if (window.plcSystem && window.plcSystem.devices) {
        const devices = Array.from(window.plcSystem.devices.values());
        devices.forEach(device => {
          const option = document.createElement('option');
          option.value = device.id;
          option.textContent = `${device.name} (${device.id})`;
          deviceSelect.appendChild(option);
        });
      }
      
      // Populate command type select
      const commandSelect = document.getElementById('command-type');
      const commandTypes = agents.echoScript.getCommandTypes();
      commandTypes.forEach(type => {
        const option = document.createElement('option');
        option.value = type;
        option.textContent = type.charAt(0).toUpperCase() + type.slice(1);
        commandSelect.appendChild(option);
      });
    }
    
    // Inject script
    async function injectScript(event) {
      event.preventDefault();
      
      const deviceId = document.getElementById('device-select').value;
      const commandType = document.getElementById('command-type').value;
      const script = document.getElementById('script-content').value;
      const force = document.getElementById('force-execute').checked;
      
      try {
        const scriptId = await agents.echoScript.injectScript(deviceId, commandType, script, {
          force,
          acknowledgeWarnings: force
        });
        
        alert(`‚úì Script injected successfully!\nScript ID: ${scriptId}`);
        
        // Clear form
        document.getElementById('script-form').reset();
        
        // Refresh history
        updateScriptHistory();
      } catch (error) {
        alert(`‚úó Failed to inject script:\n${error.message}`);
      }
    }
    
    // View agent details
    function viewAgentDetails(agentName) {
      const agent = agentName.includes('Mobile') ? agents.mobilePower :
                   agentName.includes('Device') ? agents.deviceIdent :
                   agents.echoScript;
      
      const health = agent.getHealth();
      alert(`${agentName}\n\n${JSON.stringify(health, null, 2)}`);
    }
    
    // Restart agent
    function restartAgent(agentName) {
      if (confirm(`Are you sure you want to restart ${agentName}?`)) {
        alert('Agent restart functionality coming soon!');
      }
    }
    
    // Refresh dashboard
    function refreshDashboard() {
      renderAgentCards();
      updateDeviceList();
      updateScriptHistory();
      console.log('[Dashboard] Refreshed');
    }
    
    // Initialize on page load
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initDashboard);
    } else {
      initDashboard();
    }
  </script>
    <script src="/js/universal-utilities.js"></script>

    <!-- Universal Navigation - Added by Project Fixer -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof BarbrickUniversal !== 'undefined') {
                // Only add navigation if not already present
                if (!document.querySelector('.universal-header')) {
                    BarbrickUniversal.createBackButton();
                }
                
                // Add footer if not present
                if (!document.querySelector('.universal-footer')) {
                    BarbrickUniversal.createFooter();
                }
            }
        });
    </script>
</body>
</html>
