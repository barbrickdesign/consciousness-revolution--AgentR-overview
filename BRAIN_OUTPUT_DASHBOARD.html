<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Brain Output Dashboard - What Has The Brain Produced?</title>
<style>
  :root {
    --bg: #0a0a0f;
    --surface: #12121a;
    --border: #1e1e2e;
    --text: #e0e0e0;
    --dim: #666;
    --accent: #00ff88;
    --warn: #ff6644;
    --info: #4488ff;
    --gold: #ffd700;
    --purple: #aa66ff;
  }
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body {
    font-family: 'Segoe UI', -apple-system, sans-serif;
    background: var(--bg);
    color: var(--text);
    min-height: 100vh;
    padding: 20px;
  }

  /* HEADER */
  .header {
    text-align: center;
    padding: 30px 0 20px;
    border-bottom: 1px solid var(--border);
    margin-bottom: 30px;
  }
  .header h1 {
    font-size: 28px;
    font-weight: 300;
    letter-spacing: 2px;
    color: var(--accent);
  }
  .header .subtitle {
    color: var(--dim);
    font-size: 14px;
    margin-top: 8px;
  }
  .header .last-updated {
    color: var(--dim);
    font-size: 12px;
    margin-top: 4px;
  }

  /* SCOREBOARD - THE BIG NUMBERS */
  .scoreboard {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
    gap: 16px;
    margin-bottom: 30px;
  }
  .score-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 20px;
    text-align: center;
    transition: border-color 0.3s;
  }
  .score-card:hover { border-color: var(--accent); }
  .score-card .number {
    font-size: 42px;
    font-weight: 700;
    line-height: 1;
  }
  .score-card .label {
    font-size: 12px;
    color: var(--dim);
    text-transform: uppercase;
    letter-spacing: 1px;
    margin-top: 8px;
  }
  .number.green { color: var(--accent); }
  .number.blue { color: var(--info); }
  .number.gold { color: var(--gold); }
  .number.purple { color: var(--purple); }
  .number.red { color: var(--warn); }
  .number.zero { color: #333; }

  /* SECTIONS */
  .section {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 20px;
    margin-bottom: 20px;
  }
  .section h2 {
    font-size: 16px;
    font-weight: 600;
    color: var(--accent);
    margin-bottom: 16px;
    padding-bottom: 8px;
    border-bottom: 1px solid var(--border);
  }

  /* GRID LAYOUTS */
  .two-col {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
  }
  @media (max-width: 768px) {
    .two-col { grid-template-columns: 1fr; }
  }

  /* CHART - Simple CSS bar chart */
  .bar-chart {
    display: flex;
    flex-direction: column;
    gap: 8px;
  }
  .bar-row {
    display: flex;
    align-items: center;
    gap: 10px;
  }
  .bar-label {
    width: 100px;
    font-size: 12px;
    color: var(--dim);
    text-align: right;
    flex-shrink: 0;
  }
  .bar-track {
    flex: 1;
    height: 20px;
    background: #1a1a2a;
    border-radius: 4px;
    overflow: hidden;
  }
  .bar-fill {
    height: 100%;
    border-radius: 4px;
    transition: width 0.5s ease;
    min-width: 2px;
  }
  .bar-value {
    width: 50px;
    font-size: 12px;
    color: var(--text);
  }

  /* TIMELINE CHART */
  .timeline-chart {
    display: flex;
    align-items: flex-end;
    gap: 2px;
    height: 120px;
    padding: 10px 0;
  }
  .timeline-bar {
    flex: 1;
    background: var(--accent);
    border-radius: 2px 2px 0 0;
    min-width: 4px;
    opacity: 0.7;
    transition: opacity 0.2s;
    position: relative;
  }
  .timeline-bar:hover {
    opacity: 1;
  }
  .timeline-bar:hover::after {
    content: attr(data-tooltip);
    position: absolute;
    bottom: 100%;
    left: 50%;
    transform: translateX(-50%);
    background: #222;
    color: white;
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 11px;
    white-space: nowrap;
    z-index: 10;
  }

  /* TABLE */
  .exec-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 13px;
  }
  .exec-table th {
    text-align: left;
    padding: 8px 10px;
    color: var(--dim);
    font-weight: 500;
    border-bottom: 1px solid var(--border);
    font-size: 11px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }
  .exec-table td {
    padding: 8px 10px;
    border-bottom: 1px solid #111;
    vertical-align: top;
  }
  .exec-table tr:hover td { background: #1a1a2a; }

  .badge {
    display: inline-block;
    padding: 2px 8px;
    border-radius: 4px;
    font-size: 11px;
    font-weight: 500;
  }
  .badge-success { background: #0a3a1a; color: var(--accent); }
  .badge-fail { background: #3a0a0a; color: var(--warn); }
  .badge-type { background: #1a1a3a; color: var(--info); }

  /* SPINE STATUS */
  .daemon-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
    gap: 10px;
  }
  .daemon-card {
    background: #1a1a2a;
    border-radius: 6px;
    padding: 12px;
    text-align: center;
  }
  .daemon-card .name {
    font-size: 12px;
    font-weight: 600;
    color: var(--info);
  }
  .daemon-card .runs {
    font-size: 20px;
    font-weight: 700;
    color: var(--text);
    margin: 4px 0;
  }
  .daemon-card .interval {
    font-size: 11px;
    color: var(--dim);
  }
  .daemon-card.healthy { border-left: 3px solid var(--accent); }
  .daemon-card.stale { border-left: 3px solid var(--warn); }
  .daemon-card.dead { border-left: 3px solid #333; }

  /* EMPTY STATE */
  .empty-state {
    text-align: center;
    padding: 40px 20px;
    color: var(--dim);
  }
  .empty-state .icon { font-size: 48px; margin-bottom: 16px; }
  .empty-state h3 { color: var(--text); margin-bottom: 8px; }
  .empty-state code {
    background: #1a1a2a;
    padding: 2px 8px;
    border-radius: 4px;
    font-size: 13px;
  }

  /* FOOTER */
  .footer {
    text-align: center;
    padding: 20px;
    color: var(--dim);
    font-size: 12px;
    border-top: 1px solid var(--border);
    margin-top: 30px;
  }

  /* LOADING */
  .loading {
    text-align: center;
    padding: 60px;
    color: var(--dim);
  }
  .loading .spinner {
    display: inline-block;
    width: 24px;
    height: 24px;
    border: 2px solid var(--border);
    border-top-color: var(--accent);
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
  }
  @keyframes spin { to { transform: rotate(360deg); } }

  /* ZERO STATE CALLOUT */
  .zero-callout {
    background: linear-gradient(135deg, #1a0a0a, #0a0a1a);
    border: 1px solid #332200;
    border-radius: 8px;
    padding: 24px;
    margin-bottom: 24px;
    text-align: center;
  }
  .zero-callout h3 {
    color: var(--gold);
    margin-bottom: 8px;
  }
  .zero-callout p {
    color: var(--dim);
    font-size: 14px;
    line-height: 1.6;
  }
  .zero-callout code {
    background: #1a1a2a;
    padding: 2px 8px;
    border-radius: 4px;
    color: var(--accent);
  }
</style>
</head>
<body>

<div class="header">
  <h1>BRAIN OUTPUT DASHBOARD</h1>
  <div class="subtitle">What has the brain PRODUCED? Measurable outputs only.</div>
  <div class="last-updated" id="lastUpdated">Loading...</div>
</div>

<div id="app">
  <div class="loading">
    <div class="spinner"></div>
    <p style="margin-top:12px">Loading brain metrics...</p>
  </div>
</div>

<div class="footer">
  OVERKORE v13 | Brain Output Dashboard | Refresh: <code>python .consciousness/EXPORT_BRAIN_METRICS.py</code>
</div>

<script>
const METRICS_URL = './brain_metrics.json';

async function loadMetrics() {
  try {
    const resp = await fetch(METRICS_URL + '?t=' + Date.now());
    if (!resp.ok) throw new Error('No metrics file found');
    return await resp.json();
  } catch (e) {
    return null;
  }
}

function fmtNum(n) {
  if (n >= 1000000) return (n/1000000).toFixed(1) + 'M';
  if (n >= 1000) return (n/1000).toFixed(1) + 'K';
  return String(n);
}

function timeAgo(iso) {
  if (!iso) return 'never';
  const diff = (Date.now() - new Date(iso).getTime()) / 1000;
  if (diff < 60) return Math.floor(diff) + 's ago';
  if (diff < 3600) return Math.floor(diff/60) + 'm ago';
  if (diff < 86400) return Math.floor(diff/3600) + 'h ago';
  return Math.floor(diff/86400) + 'd ago';
}

function renderDashboard(m) {
  const app = document.getElementById('app');
  const sb = m.scoreboard || {};
  const outputs = m.outputs || {};
  const tasks = m.tasks || {};
  const content = m.content || {};
  const spine = m.spine || {};
  const atomsByDay = m.atoms_by_day || {};
  const filesRecent = m.files_recent || {};
  const deploys = m.deployments || {};

  const totalOutputs = sb.autonomous_executions || 0;

  // Update timestamp
  document.getElementById('lastUpdated').textContent =
    'Last export: ' + (m.exported_at ? new Date(m.exported_at).toLocaleString() : 'unknown');

  let html = '';

  // ZERO STATE CALLOUT (only if no executions yet)
  if (totalOutputs === 0) {
    html += `
    <div class="zero-callout">
      <h3>No Autonomous Executions Yet</h3>
      <p>
        The brain has 163K atoms, 11 running daemons, and a full task queue --
        but ZERO autonomous outputs. This dashboard tracks what D12-EXECUTE produces.<br>
        Log an output: <code>python EXPORT_BRAIN_METRICS.py --log "Built page" "file_created" "path"</code>
      </p>
    </div>`;
  }

  // SCOREBOARD
  html += '<div class="scoreboard">';
  html += scoreCard(totalOutputs, 'Autonomous Outputs', totalOutputs > 0 ? 'green' : 'zero');
  html += scoreCard(sb.files_produced || 0, 'Files Produced', sb.files_produced > 0 ? 'blue' : 'zero');
  html += scoreCard(sb.deployments || 0, 'Deployments', sb.deployments > 0 ? 'purple' : 'zero');
  html += scoreCard(sb.patterns_found || 0, 'Patterns Found', sb.patterns_found > 0 ? 'gold' : 'zero');
  html += scoreCard(content.total_atoms || 0, 'Brain Atoms', 'green');
  html += scoreCard(tasks.total_completed || 0, 'Tasks Completed', (tasks.total_completed||0) > 0 ? 'blue' : 'zero');
  html += scoreCard(tasks.human_blocked || 0, 'Human Blocked', (tasks.human_blocked||0) > 0 ? 'red' : 'zero');
  html += scoreCard(outputs.success_rate || 0, 'Success Rate %', (outputs.success_rate||0) >= 80 ? 'green' : 'gold');
  html += '</div>';

  // TWO COLUMN: Atom Timeline + Content Breakdown
  html += '<div class="two-col">';

  // Atom creation timeline (last 30 days)
  html += '<div class="section">';
  html += '<h2>Atoms Created (Last 30 Days)</h2>';
  const days = Object.keys(atomsByDay).sort();
  if (days.length > 0) {
    const maxVal = Math.max(...Object.values(atomsByDay), 1);
    html += '<div class="timeline-chart">';
    for (const day of days) {
      const val = atomsByDay[day];
      const pct = Math.max((val / maxVal) * 100, 2);
      const label = day.slice(5) + ': ' + val;
      html += `<div class="timeline-bar" style="height:${pct}%" data-tooltip="${label}"></div>`;
    }
    html += '</div>';
    const totalRecent = Object.values(atomsByDay).reduce((a,b) => a+b, 0);
    html += `<div style="text-align:center;color:var(--dim);font-size:12px;margin-top:8px">${fmtNum(totalRecent)} atoms in 30 days</div>`;
  } else {
    html += '<div style="color:var(--dim);text-align:center;padding:20px">No atom data available</div>';
  }
  html += '</div>';

  // Content breakdown
  html += '<div class="section">';
  html += '<h2>Brain Content Breakdown</h2>';
  const topTypes = content.top_types || {};
  const typeKeys = Object.keys(topTypes).slice(0, 10);
  if (typeKeys.length > 0) {
    const maxType = Math.max(...Object.values(topTypes), 1);
    const colors = ['#00ff88','#4488ff','#ffd700','#aa66ff','#ff6644','#44dddd','#88cc44','#ff88aa','#8888ff','#dddd44'];
    html += '<div class="bar-chart">';
    typeKeys.forEach((key, i) => {
      const val = topTypes[key];
      const pct = (val / maxType) * 100;
      const color = colors[i % colors.length];
      html += `
      <div class="bar-row">
        <div class="bar-label">${key}</div>
        <div class="bar-track">
          <div class="bar-fill" style="width:${pct}%;background:${color}"></div>
        </div>
        <div class="bar-value">${fmtNum(val)}</div>
      </div>`;
    });
    html += '</div>';
  }
  html += '</div>';
  html += '</div>'; // end two-col

  // RECENT EXECUTIONS TABLE
  html += '<div class="section">';
  html += '<h2>Recent Autonomous Executions</h2>';
  const recent = outputs.recent || [];
  if (recent.length > 0) {
    html += `<table class="exec-table">
      <thead><tr>
        <th>Task</th><th>Type</th><th>Output</th><th>Status</th><th>Duration</th><th>When</th>
      </tr></thead><tbody>`;
    for (const r of recent) {
      const badge = r.success ? '<span class="badge badge-success">OK</span>' : '<span class="badge badge-fail">FAIL</span>';
      const dur = r.duration ? r.duration.toFixed(1) + 's' : '-';
      const path = r.path ? r.path.split('/').pop().split('\\').pop() : '-';
      html += `<tr>
        <td>${escHtml(r.task || '-')}</td>
        <td><span class="badge badge-type">${r.type || '-'}</span></td>
        <td title="${escHtml(r.path || '')}">${escHtml(path)}</td>
        <td>${badge}</td>
        <td>${dur}</td>
        <td>${timeAgo(r.completed)}</td>
      </tr>`;
    }
    html += '</tbody></table>';
  } else {
    html += `<div class="empty-state">
      <div class="icon">-</div>
      <h3>No executions logged yet</h3>
      <p>When D12-EXECUTE runs tasks autonomously, results appear here.</p>
      <p style="margin-top:12px">Manual log: <code>python EXPORT_BRAIN_METRICS.py --log "desc" "type"</code></p>
    </div>`;
  }
  html += '</div>';

  // TWO COLUMN: Spine Health + Execution by Type
  html += '<div class="two-col">';

  // SPINE HEALTH
  html += '<div class="section">';
  html += '<h2>SPINE Daemon Health</h2>';
  const daemons = spine.daemons || {};
  const daemonNames = Object.keys(daemons);
  if (daemonNames.length > 0) {
    html += '<div class="daemon-grid">';
    for (const name of daemonNames) {
      const d = daemons[name];
      const runs = d.run_count || 0;
      const errors = d.error_count || 0;
      const interval = d.interval || 0;
      const lastRun = d.last_run;

      let health = 'healthy';
      if (!lastRun) health = 'dead';
      else {
        const age = (Date.now() - new Date(lastRun).getTime()) / 1000;
        if (age > interval * 3) health = 'stale';
      }

      const intervalLabel = interval >= 3600 ? (interval/3600) + 'h' : (interval/60) + 'm';
      html += `
      <div class="daemon-card ${health}">
        <div class="name">${name}</div>
        <div class="runs">${runs}</div>
        <div class="interval">${intervalLabel} interval${errors > 0 ? ' | ' + errors + ' errors' : ''}</div>
      </div>`;
    }
    html += '</div>';
  } else {
    html += '<div style="color:var(--dim);text-align:center;padding:20px">SPINE not running or no state file</div>';
  }
  html += '</div>';

  // EXECUTION BY TYPE (pie-like breakdown)
  html += '<div class="section">';
  html += '<h2>Output Types</h2>';
  const byType = outputs.by_type || {};
  const typeEntries = Object.entries(byType);
  if (typeEntries.length > 0) {
    const maxExec = Math.max(...typeEntries.map(e => e[1]), 1);
    const execColors = {'file_created':'#00ff88','file_modified':'#4488ff','deployment':'#aa66ff',
                        'content_piece':'#ffd700','pattern_found':'#ff88aa','task_completed':'#44dddd'};
    html += '<div class="bar-chart">';
    for (const [type, count] of typeEntries) {
      const pct = (count / maxExec) * 100;
      const color = execColors[type] || '#888';
      html += `
      <div class="bar-row">
        <div class="bar-label">${type.replace(/_/g, ' ')}</div>
        <div class="bar-track">
          <div class="bar-fill" style="width:${pct}%;background:${color}"></div>
        </div>
        <div class="bar-value">${count}</div>
      </div>`;
    }
    html += '</div>';
  } else {
    html += `<div class="empty-state">
      <div class="icon">-</div>
      <h3>No output types yet</h3>
      <p>Types: file_created, file_modified, deployment, content_piece, pattern_found, task_completed</p>
    </div>`;
  }
  html += '</div>';
  html += '</div>'; // end two-col

  // FILE ACTIVITY
  html += '<div class="section">';
  html += '<h2>File Activity (Last 24h)</h2>';
  html += `<div class="scoreboard" style="margin-bottom:0">`;
  html += scoreCard(filesRecent.created_24h || 0, 'Files Created', 'green');
  html += scoreCard(filesRecent.modified_24h || 0, 'Files Modified', 'blue');
  html += scoreCard(Object.values(m.atoms_recent || {}).reduce((a,b)=>a+b, 0), 'Atoms Added', 'gold');
  html += scoreCard(deploys.total || 0, 'Total Deploys', 'purple');
  html += '</div>';
  html += '</div>';

  app.innerHTML = html;
}

function scoreCard(value, label, color) {
  const display = typeof value === 'number' ? fmtNum(value) : value;
  return `<div class="score-card">
    <div class="number ${color}">${display}</div>
    <div class="label">${label}</div>
  </div>`;
}

function escHtml(s) {
  const div = document.createElement('div');
  div.textContent = s;
  return div.innerHTML;
}

// INIT
(async function() {
  const metrics = await loadMetrics();
  if (metrics) {
    renderDashboard(metrics);
  } else {
    document.getElementById('app').innerHTML = `
    <div class="empty-state" style="padding:60px">
      <div class="icon">-</div>
      <h3>No metrics file found</h3>
      <p>Run <code>python .consciousness/EXPORT_BRAIN_METRICS.py</code> to generate brain_metrics.json</p>
    </div>`;
  }

  // Auto-refresh every 60 seconds
  setInterval(async () => {
    const m = await loadMetrics();
    if (m) renderDashboard(m);
  }, 60000);
})();
</script>
</body>
</html>
