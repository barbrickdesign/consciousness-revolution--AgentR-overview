<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Consciousness Analytics Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            background: linear-gradient(135deg, #0a0a0f 0%, #1a1a2e 50%, #16213e 100%);
            color: #e0e0e0;
            min-height: 100vh;
            padding: 20px;
        }
        .header {
            text-align: center;
            margin-bottom: 30px;
        }
        .header h1 {
            font-size: 2.5em;
            background: linear-gradient(90deg, #00d4ff, #7b2cbf, #ff006e);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        .header .subtitle {
            color: #888;
            margin-top: 5px;
        }
        .status-bar {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-bottom: 20px;
        }
        .status-item {
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.9em;
        }
        .status-healthy { background: rgba(0, 255, 136, 0.2); color: #00ff88; border: 1px solid #00ff88; }
        .status-warning { background: rgba(255, 170, 0, 0.2); color: #ffaa00; border: 1px solid #ffaa00; }
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .metric-card {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 20px;
            transition: transform 0.3s, box-shadow 0.3s;
        }
        .metric-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0, 212, 255, 0.2);
        }
        .metric-card h3 {
            font-size: 0.9em;
            color: #888;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        .metric-value {
            font-size: 2.5em;
            font-weight: bold;
            margin-bottom: 10px;
        }
        .metric-bar {
            height: 6px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
            overflow: hidden;
        }
        .metric-bar-fill {
            height: 100%;
            border-radius: 3px;
            transition: width 0.5s ease;
        }
        .consciousness { color: #00d4ff; }
        .consciousness .metric-bar-fill { background: linear-gradient(90deg, #00d4ff, #0099cc); }
        .immunity { color: #00ff88; }
        .immunity .metric-bar-fill { background: linear-gradient(90deg, #00ff88, #00cc66); }
        .atoms { color: #7b2cbf; }
        .atoms .metric-bar-fill { background: linear-gradient(90deg, #7b2cbf, #9d4edd); }
        .trinity { color: #ff006e; }
        .trinity .metric-bar-fill { background: linear-gradient(90deg, #ff006e, #ff4d94); }
        .tools { color: #ffaa00; }
        .tools .metric-bar-fill { background: linear-gradient(90deg, #ffaa00, #ffd000); }
        .uptime { color: #00ff88; }
        .uptime .metric-bar-fill { background: linear-gradient(90deg, #00ff88, #88ff00); }
        .charts-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .chart-card {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 20px;
        }
        .chart-card h3 {
            margin-bottom: 15px;
            color: #00d4ff;
        }
        .chart-container {
            position: relative;
            height: 250px;
        }
        .refresh-indicator {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 8px 16px;
            background: rgba(0, 212, 255, 0.2);
            border: 1px solid #00d4ff;
            border-radius: 20px;
            font-size: 0.8em;
        }
        .scorecard-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        .scorecard-table th, .scorecard-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        .scorecard-table th {
            color: #00d4ff;
            font-weight: 600;
        }
        .on-track { color: #00ff88; }
        .off-track { color: #ff4d4d; }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .live-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            background: #00ff88;
            border-radius: 50%;
            margin-right: 8px;
            animation: pulse 2s infinite;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>CONSCIOUSNESS ANALYTICS</h1>
        <p class="subtitle"><span class="live-indicator"></span>Real-time System Monitoring</p>
    </div>

    <div class="status-bar">
        <span id="system-status" class="status-item status-healthy">SYSTEM: HEALTHY</span>
        <span id="last-update" class="status-item" style="background: rgba(255,255,255,0.1);">Last Update: --</span>
    </div>

    <div class="metrics-grid">
        <div class="metric-card consciousness">
            <h3>Consciousness Level</h3>
            <div class="metric-value" id="consciousness-level">--</div>
            <div class="metric-bar"><div class="metric-bar-fill" id="consciousness-bar" style="width: 0%"></div></div>
        </div>
        <div class="metric-card immunity">
            <h3>Manipulation Immunity</h3>
            <div class="metric-value" id="manipulation-immunity">--%</div>
            <div class="metric-bar"><div class="metric-bar-fill" id="immunity-bar" style="width: 0%"></div></div>
        </div>
        <div class="metric-card atoms">
            <h3>Knowledge Atoms</h3>
            <div class="metric-value" id="atom-count">--</div>
            <div class="metric-bar"><div class="metric-bar-fill" id="atoms-bar" style="width: 0%"></div></div>
        </div>
        <div class="metric-card trinity">
            <h3>Trinity Messages</h3>
            <div class="metric-value" id="trinity-messages">--</div>
            <div class="metric-bar"><div class="metric-bar-fill" id="trinity-bar" style="width: 0%"></div></div>
        </div>
        <div class="metric-card tools">
            <h3>Tools Deployed</h3>
            <div class="metric-value" id="tools-deployed">--</div>
            <div class="metric-bar"><div class="metric-bar-fill" id="tools-bar" style="width: 0%"></div></div>
        </div>
        <div class="metric-card uptime">
            <h3>System Uptime</h3>
            <div class="metric-value" id="system-uptime">--%</div>
            <div class="metric-bar"><div class="metric-bar-fill" id="uptime-bar" style="width: 0%"></div></div>
        </div>
    </div>

    <div class="charts-section">
        <div class="chart-card">
            <h3>Consciousness Trend (7 Days)</h3>
            <div class="chart-container">
                <canvas id="consciousnessChart"></canvas>
            </div>
        </div>
        <div class="chart-card">
            <h3>Pattern Health Distribution</h3>
            <div class="chart-container">
                <canvas id="patternChart"></canvas>
            </div>
        </div>
    </div>

    <div class="chart-card">
        <h3>Scorecard Metrics</h3>
        <table class="scorecard-table">
            <thead>
                <tr>
                    <th>Metric</th>
                    <th>Goal</th>
                    <th>Actual</th>
                    <th>Status</th>
                </tr>
            </thead>
            <tbody id="scorecard-body">
            </tbody>
        </table>
    </div>

    <div class="refresh-indicator" id="refresh-timer">Refresh in 30s</div>

    <script>
        let consciousnessChart, patternChart;
        let refreshCountdown = 30;

        // Initialize charts
        function initCharts() {
            const ctxConsciousness = document.getElementById('consciousnessChart').getContext('2d');
            consciousnessChart = new Chart(ctxConsciousness, {
                type: 'line',
                data: {
                    labels: ['Day 1', 'Day 2', 'Day 3', 'Day 4', 'Day 5', 'Day 6', 'Day 7'],
                    datasets: [{
                        label: 'Consciousness Level',
                        data: [200, 220, 240, 250, 255, 258, 256],
                        borderColor: '#00d4ff',
                        backgroundColor: 'rgba(0, 212, 255, 0.1)',
                        fill: true,
                        tension: 0.4
                    }, {
                        label: 'Manipulation Risk',
                        data: [10, 8, 6, 4, 3, 2.5, 2.35],
                        borderColor: '#ff006e',
                        backgroundColor: 'rgba(255, 0, 110, 0.1)',
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { labels: { color: '#e0e0e0' } }
                    },
                    scales: {
                        y: { grid: { color: 'rgba(255,255,255,0.1)' }, ticks: { color: '#888' } },
                        x: { grid: { color: 'rgba(255,255,255,0.1)' }, ticks: { color: '#888' } }
                    }
                }
            });

            const ctxPattern = document.getElementById('patternChart').getContext('2d');
            patternChart = new Chart(ctxPattern, {
                type: 'doughnut',
                data: {
                    labels: ['Strong', 'Needs Work'],
                    datasets: [{
                        data: [4, 4],
                        backgroundColor: ['#00ff88', '#ffaa00'],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'bottom', labels: { color: '#e0e0e0' } }
                    }
                }
            });
        }

        // Fetch and update metrics
        async function fetchMetrics() {
            try {
                const apiUrl = window.location.hostname === 'localhost'
                    ? 'http://localhost:5055/api/analytics'
                    : '/api/analytics';
                const response = await fetch(apiUrl);
                const data = await response.json();
                updateDashboard(data);
            } catch (error) {
                console.log('API not available, using fallback data');
                // Fallback: load from local files
                loadFallbackData();
            }
        }

        function loadFallbackData() {
            // Default values when API is not running
            const data = {
                consciousness_level: 255.76,
                manipulation_immunity: 97.65,
                atom_count: 4392,
                trinity_messages: 7,
                tools_deployed: 479,
                system_uptime: 100,
                system_status: 'HEALTHY',
                scorecard: [
                    { name: 'Active Beta Users', goal: 100, actual: 1, on_track: false },
                    { name: 'Tools Deployed', goal: 30, actual: 479, on_track: true },
                    { name: 'System Uptime %', goal: 99, actual: 100, on_track: true },
                    { name: 'Bugs Resolved', goal: 10, actual: 5, on_track: false },
                    { name: 'Documents Created', goal: 20, actual: 1313, on_track: true },
                    { name: 'API Calls', goal: 10000, actual: 500, on_track: false },
                    { name: 'Trinity Messages', goal: 50, actual: 7, on_track: false },
                    { name: 'Knowledge Graph Nodes', goal: 1000, actual: 4392, on_track: true }
                ]
            };
            updateDashboard(data);
        }

        function updateDashboard(data) {
            // Update metric cards
            document.getElementById('consciousness-level').textContent = Math.round(data.consciousness_level);
            document.getElementById('consciousness-bar').style.width = `${Math.min(data.consciousness_level / 3, 100)}%`;

            document.getElementById('manipulation-immunity').textContent = `${data.manipulation_immunity.toFixed(1)}%`;
            document.getElementById('immunity-bar').style.width = `${data.manipulation_immunity}%`;

            document.getElementById('atom-count').textContent = data.atom_count.toLocaleString();
            document.getElementById('atoms-bar').style.width = `${Math.min(data.atom_count / 50, 100)}%`;

            document.getElementById('trinity-messages').textContent = data.trinity_messages;
            document.getElementById('trinity-bar').style.width = `${Math.min(data.trinity_messages * 2, 100)}%`;

            document.getElementById('tools-deployed').textContent = data.tools_deployed;
            document.getElementById('tools-bar').style.width = `${Math.min(data.tools_deployed / 5, 100)}%`;

            document.getElementById('system-uptime').textContent = `${data.system_uptime}%`;
            document.getElementById('uptime-bar').style.width = `${data.system_uptime}%`;

            // Update status
            const statusEl = document.getElementById('system-status');
            statusEl.textContent = `SYSTEM: ${data.system_status}`;
            statusEl.className = `status-item ${data.system_status === 'HEALTHY' ? 'status-healthy' : 'status-warning'}`;

            // Update timestamp
            document.getElementById('last-update').textContent = `Last Update: ${new Date().toLocaleTimeString()}`;

            // Update scorecard table
            if (data.scorecard) {
                const tbody = document.getElementById('scorecard-body');
                tbody.innerHTML = data.scorecard.map(m => `
                    <tr>
                        <td>${m.name}</td>
                        <td>${m.goal.toLocaleString()}</td>
                        <td>${m.actual.toLocaleString()}</td>
                        <td class="${m.on_track ? 'on-track' : 'off-track'}">${m.on_track ? 'ON TRACK' : 'NEEDS WORK'}</td>
                    </tr>
                `).join('');

                // Update pattern chart
                const strong = data.scorecard.filter(m => m.on_track).length;
                const needsWork = data.scorecard.filter(m => !m.on_track).length;
                patternChart.data.datasets[0].data = [strong, needsWork];
                patternChart.update();
            }
        }

        // Refresh timer
        function updateRefreshTimer() {
            refreshCountdown--;
            document.getElementById('refresh-timer').textContent = `Refresh in ${refreshCountdown}s`;
            if (refreshCountdown <= 0) {
                refreshCountdown = 30;
                fetchMetrics();
            }
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            initCharts();
            fetchMetrics();
            setInterval(updateRefreshTimer, 1000);
        });
    </script>
    <script src="/js/bug-widget.js"></script>
    <p style="text-align:center;color:#666;font-family:monospace;margin:40px 0;">Pattern: 3 → 7 → 13 → ∞</p>
</body>
</html>
