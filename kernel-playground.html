<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KERNEL Prompt Engineering Playground - Barbrick Design</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        header {
            text-align: center;
            margin-bottom: 40px;
        }

        h1 {
            color: #667eea;
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .subtitle {
            color: #666;
            font-size: 1.1em;
        }

        .back-link {
            display: inline-block;
            margin-bottom: 20px;
            color: #667eea;
            text-decoration: none;
            font-weight: bold;
        }

        .back-link:hover {
            text-decoration: underline;
        }

        .grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }

        @media (max-width: 1024px) {
            .grid {
                grid-template-columns: 1fr;
            }
        }

        .section {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 10px;
            border: 2px solid #e9ecef;
        }

        .section h2 {
            color: #495057;
            font-size: 1.5em;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .section h2::before {
            content: 'üéØ';
            font-size: 1.2em;
        }

        label {
            display: block;
            color: #495057;
            font-weight: 600;
            margin-bottom: 8px;
            margin-top: 15px;
        }

        input[type="text"],
        textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            font-size: 1em;
            font-family: inherit;
            transition: border-color 0.3s;
        }

        input[type="text"]:focus,
        textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        textarea {
            min-height: 100px;
            resize: vertical;
        }

        .item-list {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 10px;
        }

        .item {
            background: white;
            padding: 8px 12px;
            border-radius: 6px;
            border: 1px solid #dee2e6;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .item button {
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 2px 6px;
            cursor: pointer;
            font-size: 0.9em;
        }

        .item button:hover {
            background: #c82333;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-success:hover {
            background: #218838;
        }

        .quick-patterns {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 20px;
        }

        .quick-patterns button {
            padding: 8px 16px;
            background: #e9ecef;
            border: 2px solid #dee2e6;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .quick-patterns button:hover {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .score-display {
            text-align: center;
            padding: 30px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 10px;
            margin-bottom: 30px;
        }

        .score-number {
            font-size: 4em;
            font-weight: bold;
            margin: 20px 0;
        }

        .score-grade {
            font-size: 1.5em;
            margin-bottom: 10px;
        }

        .score-breakdown {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .score-item {
            background: rgba(255, 255, 255, 0.2);
            padding: 15px;
            border-radius: 8px;
        }

        .score-item-title {
            font-size: 0.9em;
            opacity: 0.9;
            margin-bottom: 5px;
        }

        .score-item-value {
            font-size: 1.5em;
            font-weight: bold;
        }

        .recommendations {
            background: #fff3cd;
            border: 2px solid #ffc107;
            border-radius: 8px;
            padding: 20px;
            margin-top: 20px;
        }

        .recommendations h3 {
            color: #856404;
            margin-bottom: 15px;
        }

        .recommendations ul {
            list-style-position: inside;
            color: #856404;
        }

        .recommendations li {
            margin-bottom: 8px;
        }

        .prompt-output {
            background: #2d3748;
            color: #e2e8f0;
            padding: 20px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            white-space: pre-wrap;
            max-height: 500px;
            overflow-y: auto;
        }

        .buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 20px;
        }

        .kernel-principles {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }

        .principle-card {
            background: white;
            padding: 15px;
            border-radius: 8px;
            border: 2px solid #e9ecef;
            text-align: center;
        }

        .principle-icon {
            font-size: 2em;
            margin-bottom: 10px;
        }

        .principle-name {
            font-weight: bold;
            color: #495057;
            margin-bottom: 5px;
        }

        .principle-desc {
            font-size: 0.9em;
            color: #6c757d;
        }

        .metrics-dashboard {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-top: 20px;
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
        }

        .metric-box {
            background: white;
            padding: 15px;
            border-radius: 6px;
            text-align: center;
            border: 2px solid #dee2e6;
        }

        .metric-value {
            font-size: 2em;
            font-weight: bold;
            color: #667eea;
        }

        .metric-label {
            font-size: 0.9em;
            color: #6c757d;
            margin-top: 5px;
        }
    </style>
    <link rel="stylesheet" href="/css/universal-styles.css">
</head>
<body>
    <div class="container">
        <a href="index.html" class="back-link">‚Üê Back to Hub</a>
        
        <header>
            <h1>üéØ KERNEL Prompt Playground</h1>
            <p class="subtitle">Build, validate, and optimize AI prompts using the KERNEL framework</p>
        </header>

        <div class="kernel-principles">
            <div class="principle-card">
                <div class="principle-icon">üéØ</div>
                <div class="principle-name">Keep it Simple</div>
                <div class="principle-desc">One clear goal</div>
            </div>
            <div class="principle-card">
                <div class="principle-icon">‚úÖ</div>
                <div class="principle-name">Easy to Verify</div>
                <div class="principle-desc">Clear success criteria</div>
            </div>
            <div class="principle-card">
                <div class="principle-icon">üîÑ</div>
                <div class="principle-name">Reproducible</div>
                <div class="principle-desc">Consistent results</div>
            </div>
            <div class="principle-card">
                <div class="principle-icon">üéØ</div>
                <div class="principle-name">Narrow Scope</div>
                <div class="principle-desc">One task only</div>
            </div>
            <div class="principle-card">
                <div class="principle-icon">üìã</div>
                <div class="principle-name">Explicit Constraints</div>
                <div class="principle-desc">What NOT to do</div>
            </div>
            <div class="principle-card">
                <div class="principle-icon">üìê</div>
                <div class="principle-name">Logical Structure</div>
                <div class="principle-desc">Clear sections</div>
            </div>
        </div>

        <div class="section">
            <h2>Quick Patterns</h2>
            <p style="margin-bottom: 15px; color: #6c757d;">Start with a common pattern:</p>
            <div class="quick-patterns">
                <button onclick="loadPattern('code')">üíª Code Generation</button>
                <button onclick="loadPattern('docs')">üìÑ Documentation</button>
                <button onclick="loadPattern('analysis')">üìä Data Analysis</button>
                <button onclick="loadPattern('refactor')">üîß Code Refactor</button>
                <button onclick="loadPattern('custom')">‚ú® Custom</button>
            </div>
        </div>

        <div class="grid">
            <div class="section">
                <h2>Build Your Prompt</h2>
                
                <label for="task">Task (K - Keep it Simple) *</label>
                <input type="text" id="task" placeholder="One clear sentence describing your goal">

                <label for="inputItem">Input/Context</label>
                <input type="text" id="inputItem" placeholder="Add context item and press Enter">
                <div class="item-list" id="inputList"></div>

                <label for="constraintItem">Constraints (E - Explicit) *</label>
                <input type="text" id="constraintItem" placeholder="Add constraint and press Enter">
                <div class="item-list" id="constraintList"></div>

                <label for="outputItem">Expected Output *</label>
                <input type="text" id="outputItem" placeholder="Add output specification and press Enter">
                <div class="item-list" id="outputList"></div>

                <label for="verifyItem">Verification (E - Easy to Verify) *</label>
                <input type="text" id="verifyItem" placeholder="Add verification step and press Enter">
                <div class="item-list" id="verifyList"></div>

                <div class="buttons">
                    <button class="btn btn-primary" onclick="buildPrompt()">üî® Build Prompt</button>
                    <button class="btn btn-secondary" onclick="resetBuilder()">üîÑ Reset</button>
                </div>
            </div>

            <div class="section">
                <h2>Generated Prompt</h2>
                <div class="prompt-output" id="promptOutput">Your KERNEL-formatted prompt will appear here...</div>
                
                <div class="buttons">
                    <button class="btn btn-primary" onclick="validatePrompt()">‚úÖ Validate</button>
                    <button class="btn btn-success" onclick="copyPrompt()">üìã Copy</button>
                    <button class="btn btn-secondary" onclick="exportPrompt()">üíæ Export JSON</button>
                    <button class="btn btn-primary" onclick="autoEnhancePrompt()" title="Automatically improve your prompt">‚ú® Auto-Enhance</button>
                </div>
            </div>
        </div>

        <!-- Smart Suggestions Panel -->
        <div id="suggestionsPanel" class="section" style="display: none;">
            <h2>üí° Smart Suggestions</h2>
            <p style="margin-bottom: 15px; color: #6c757d;">Click a suggestion to add it to your prompt:</p>
            <div id="suggestionsList"></div>
        </div>

        <!-- Template Library -->
        <div class="section">
            <h2>üìö Template Library</h2>
            <p style="margin-bottom: 15px; color: #6c757d;">Quick start with pre-built KERNEL templates:</p>
            <div class="quick-patterns">
                <button onclick="loadTemplate('api-endpoint')">üîå API Documentation</button>
                <button onclick="loadTemplate('data-processor')">üìä Data Processor</button>
                <button onclick="loadTemplate('unit-test')">üß™ Unit Test Suite</button>
                <button onclick="loadTemplate('bug-fix')">üêõ Bug Fix</button>
            </div>
        </div>

        <!-- Prompt History -->
        <div class="section" id="historySection">
            <h2>üïê Recent Prompts</h2>
            <p style="margin-bottom: 15px; color: #6c757d;">Your last few prompts (auto-saved):</p>
            <div id="historyList" style="max-height: 300px; overflow-y: auto;"></div>
        </div>

        <div id="scoreSection" style="display: none;">
            <div class="score-display">
                <div class="score-grade" id="scoreGrade">Calculating...</div>
                <div class="score-number" id="scoreNumber">-</div>
                <p>KERNEL Score</p>
                
                <div class="score-breakdown">
                    <div class="score-item">
                        <div class="score-item-title">K - Keep Simple</div>
                        <div class="score-item-value" id="scoreK">-</div>
                    </div>
                    <div class="score-item">
                        <div class="score-item-title">E - Easy Verify</div>
                        <div class="score-item-value" id="scoreE1">-</div>
                    </div>
                    <div class="score-item">
                        <div class="score-item-title">R - Reproducible</div>
                        <div class="score-item-value" id="scoreR">-</div>
                    </div>
                    <div class="score-item">
                        <div class="score-item-title">N - Narrow Scope</div>
                        <div class="score-item-value" id="scoreN">-</div>
                    </div>
                    <div class="score-item">
                        <div class="score-item-title">E - Explicit</div>
                        <div class="score-item-value" id="scoreE2">-</div>
                    </div>
                    <div class="score-item">
                        <div class="score-item-title">L - Logical</div>
                        <div class="score-item-value" id="scoreL">-</div>
                    </div>
                </div>
            </div>

            <div id="recommendationsSection" class="recommendations" style="display: none;">
                <h3>üí° Recommendations to Improve Your Prompt</h3>
                <ul id="recommendationsList"></ul>
            </div>
        </div>

        <div class="metrics-dashboard">
            <h2 style="margin-bottom: 20px;">üìä Session Metrics</h2>
            <div class="metrics-grid">
                <div class="metric-box">
                    <div class="metric-value" id="metricPrompts">0</div>
                    <div class="metric-label">Prompts Built</div>
                </div>
                <div class="metric-box">
                    <div class="metric-value" id="metricAvgScore">-</div>
                    <div class="metric-label">Avg Score</div>
                </div>
                <div class="metric-box">
                    <div class="metric-value" id="metricTokens">0</div>
                    <div class="metric-label">Est. Tokens</div>
                </div>
                <div class="metric-box">
                    <div class="metric-value" id="metricBest">-</div>
                    <div class="metric-label">Best Score</div>
                </div>
            </div>
        </div>
    </div>

    <script src="src/utils/kernel-prompt-builder.js"></script>
    <script src="src/utils/kernel-validator.js"></script>
    <script>
        // State management
        let builder = new KernelPromptBuilder();
        let validator = new KernelValidator();
        let currentPromptText = '';
        let sessionMetrics = {
            prompts: 0,
            scores: [],
            tokens: 0
        };
        let promptHistory = [];
        let autoSaveEnabled = true;

        // Load saved state from localStorage
        function loadSavedState() {
            try {
                const saved = localStorage.getItem('kernelPlaygroundState');
                if (saved) {
                    const state = JSON.parse(saved);
                    if (state.history) promptHistory = state.history;
                    if (state.metrics) sessionMetrics = state.metrics;
                    updateMetrics();
                }
            } catch (error) {
                console.error('Failed to load saved state:', error);
            }
        }

        // Save state to localStorage
        function saveState() {
            if (!autoSaveEnabled) return;
            
            try {
                const state = {
                    history: promptHistory.slice(-20), // Keep last 20
                    metrics: sessionMetrics,
                    lastSaved: new Date().toISOString()
                };
                localStorage.setItem('kernelPlaygroundState', JSON.stringify(state));
            } catch (error) {
                console.error('Failed to save state:', error);
            }
        }

        // Auto-enhance prompt based on validation results
        function autoEnhancePrompt() {
            if (!currentPromptText) {
                alert('Please build a prompt first!');
                return;
            }

            const result = validator.validate(currentPromptText);
            let enhanced = false;

            // Get current state
            rebuildFromUI();

            // Apply enhancements based on recommendations
            if (result.principles.keepSimple.score < 80) {
                // Simplify task if too complex
                const task = builder.prompt.task;
                if (task.split(/\s+/).length > 20) {
                    const words = task.split(/\s+/).slice(0, 15);
                    builder.prompt.task = words.join(' ');
                    document.getElementById('task').value = builder.prompt.task;
                    enhanced = true;
                }
            }

            if (result.principles.explicitConstraints.score < 70) {
                // Add missing common constraints
                const task = builder.prompt.task.toLowerCase();
                
                if (task.includes('python') && !builder.prompt.constraints.some(c => c.includes('Python'))) {
                    addItem('constraint', 'Python 3.10+');
                    enhanced = true;
                }
                
                if (task.includes('code') && !builder.prompt.constraints.some(c => c.toLowerCase().includes('line'))) {
                    addItem('constraint', 'Keep code concise and under 100 lines');
                    enhanced = true;
                }

                if (!builder.prompt.constraints.some(c => c.toLowerCase().includes('error'))) {
                    addItem('constraint', 'Include proper error handling');
                    enhanced = true;
                }
            }

            if (result.principles.easyVerify.score < 70) {
                // Add verification criteria
                if (builder.prompt.verify.length < 2) {
                    addItem('verify', 'Test with valid input: verify expected output');
                    addItem('verify', 'Test with invalid input: verify error handling');
                    enhanced = true;
                }
            }

            if (result.principles.logicalStructure.score < 90) {
                // Ensure all sections have content
                if (builder.prompt.input.length === 0) {
                    addItem('input', 'Define input parameters and data format');
                    enhanced = true;
                }
                
                if (builder.prompt.output.length === 0) {
                    addItem('output', 'Specify expected output format and structure');
                    enhanced = true;
                }
            }

            if (enhanced) {
                buildPrompt();
                alert('‚ú® Prompt auto-enhanced! Review the changes and validate again.');
            } else {
                alert('‚úÖ Prompt is already well-optimized! Score: ' + result.overall.score);
            }
        }

        // Generate smart suggestions based on current prompt
        function getSmartSuggestions() {
            const task = document.getElementById('task').value.toLowerCase();
            const suggestions = [];

            // Task-based suggestions
            if (task.includes('python')) {
                suggestions.push({
                    type: 'constraint',
                    text: 'Python 3.10+',
                    reason: 'Specify Python version for reproducibility'
                });
                suggestions.push({
                    type: 'constraint',
                    text: 'Use type hints',
                    reason: 'Improve code clarity and maintainability'
                });
            }

            if (task.includes('javascript') || task.includes('js')) {
                suggestions.push({
                    type: 'constraint',
                    text: 'ES6+ syntax',
                    reason: 'Use modern JavaScript features'
                });
                suggestions.push({
                    type: 'constraint',
                    text: 'Use async/await instead of callbacks',
                    reason: 'Cleaner asynchronous code'
                });
            }

            if (task.includes('api') || task.includes('endpoint')) {
                suggestions.push({
                    type: 'output',
                    text: 'Include request/response examples',
                    reason: 'Make API usage clear'
                });
                suggestions.push({
                    type: 'verify',
                    text: 'Test with valid API call',
                    reason: 'Verify API works correctly'
                });
            }

            if (task.includes('document') || task.includes('readme')) {
                suggestions.push({
                    type: 'constraint',
                    text: 'Markdown format',
                    reason: 'Standard documentation format'
                });
                suggestions.push({
                    type: 'constraint',
                    text: 'Under 1000 words',
                    reason: 'Keep documentation concise'
                });
            }

            if (task.includes('test') || task.includes('unit test')) {
                suggestions.push({
                    type: 'output',
                    text: 'Coverage report',
                    reason: 'Measure test completeness'
                });
                suggestions.push({
                    type: 'verify',
                    text: 'All tests pass',
                    reason: 'Ensure quality'
                });
            }

            return suggestions;
        }

        // Apply a suggestion
        function applySuggestion(type, text) {
            addItem(type, text);
            buildPrompt();
        }

        // Add prompt to history
        function addToHistory() {
            if (!currentPromptText) return;

            const historyItem = {
                id: Date.now(),
                task: builder.prompt.task,
                promptText: currentPromptText,
                score: validator.validate(currentPromptText).overall.score,
                timestamp: new Date().toISOString()
            };

            promptHistory.unshift(historyItem);
            if (promptHistory.length > 20) {
                promptHistory = promptHistory.slice(0, 20);
            }

            saveState();
        }

        // Load prompt from history
        function loadFromHistory(id) {
            const item = promptHistory.find(h => h.id === id);
            if (!item) return;

            // Parse and load the prompt
            const lines = item.promptText.split('\n');
            resetBuilder();

            let currentSection = '';
            for (const line of lines) {
                if (line.startsWith('TASK:')) {
                    const task = line.replace('TASK:', '').trim();
                    document.getElementById('task').value = task;
                    builder.setTask(task);
                } else if (line.startsWith('INPUT:')) {
                    currentSection = 'input';
                } else if (line.startsWith('CONSTRAINTS:')) {
                    currentSection = 'constraint';
                } else if (line.startsWith('OUTPUT:')) {
                    currentSection = 'output';
                } else if (line.startsWith('VERIFY:')) {
                    currentSection = 'verify';
                } else if (line.trim().startsWith('- ')) {
                    const text = line.trim().substring(2);
                    if (currentSection && text) {
                        addItem(currentSection, text);
                    }
                }
            }

            buildPrompt();
            alert('üìã Prompt loaded from history!');
        }

        // Template library
        const promptTemplates = {
            'api-endpoint': {
                name: 'API Endpoint Documentation',
                task: 'Create API documentation for REST endpoint',
                input: ['Endpoint URL and HTTP method', 'Request/response schema'],
                constraints: ['Markdown format', 'Under 500 words', 'Include curl examples'],
                output: ['Endpoint description', 'Request format with example', 'Response format with example', 'Error codes'],
                verify: ['All sections present', 'Examples are valid', 'Error codes documented']
            },
            'data-processor': {
                name: 'Data Processing Script',
                task: 'Create Python script to process and analyze data',
                input: ['Input data file format', 'Expected data structure'],
                constraints: ['Python 3.10+', 'pandas and numpy only', 'Script under 100 lines'],
                output: ['Processed data output', 'Summary statistics', 'Visualization charts'],
                verify: ['Run on sample data', 'Output files generated', 'Charts display correctly']
            },
            'unit-test': {
                name: 'Unit Test Suite',
                task: 'Write comprehensive unit tests for function',
                input: ['Function to test', 'Expected behaviors'],
                constraints: ['pytest framework', 'Cover edge cases', 'Minimum 80% coverage'],
                output: ['Test file with multiple test cases', 'Fixtures if needed', 'Mocks for external dependencies'],
                verify: ['All tests pass', 'Coverage report shows 80%+', 'Edge cases covered']
            },
            'bug-fix': {
                name: 'Bug Fix',
                task: 'Fix specific bug in codebase',
                input: ['Bug description and steps to reproduce', 'Current code behavior'],
                constraints: ['Minimal changes only', 'No breaking changes', 'Add test to prevent regression'],
                output: ['Fixed code', 'Explanation of changes', 'Test case for bug'],
                verify: ['Bug no longer reproduces', 'Existing tests still pass', 'New test catches bug']
            }
        };

        // Load template
        function loadTemplate(templateKey) {
            const template = promptTemplates[templateKey];
            if (!template) return;

            resetBuilder();

            document.getElementById('task').value = template.task;
            builder.setTask(template.task);

            template.input.forEach(item => addItem('input', item));
            template.constraints.forEach(item => addItem('constraint', item));
            template.output.forEach(item => addItem('output', item));
            template.verify.forEach(item => addItem('verify', item));

            buildPrompt();
            alert(`üìù Template "${template.name}" loaded!`);
        }

        // Load pattern
        function loadPattern(type) {
            resetBuilder();
            
            const patterns = {
                code: {
                    task: 'Generate Python function to validate email addresses',
                    input: ['Email string as input', 'Return boolean result'],
                    constraints: ['Python 3.10+', 'No external libraries (regex only)', 'Function under 20 lines', 'Handle edge cases'],
                    output: ['Function named validate_email(email)', 'Returns True/False', 'Includes docstring', 'Type hints included'],
                    verify: ['Test with valid email: returns True', 'Test with invalid email: returns False', 'Test with edge cases (no @, multiple @, etc.)']
                },
                docs: {
                    task: 'Create API documentation for user authentication endpoint',
                    input: ['POST /api/auth/login endpoint', 'Accepts username and password', 'Returns JWT token'],
                    constraints: ['Markdown format', 'Under 500 words', 'Include code examples'],
                    output: ['Endpoint description', 'Request format with example', 'Response format with example', 'Error codes table'],
                    verify: ['All sections present', 'Code examples are valid JSON', 'Error codes documented']
                },
                analysis: {
                    task: 'Analyze sales data and generate monthly revenue report',
                    input: ['CSV file with columns: date, product, quantity, price', 'Date range: 2024-01-01 to 2024-12-31'],
                    constraints: ['Python with pandas only', 'Include matplotlib visualization', 'Script under 100 lines'],
                    output: ['total_sales.txt with monthly breakdown', 'top_products.txt with top 10 by revenue', 'sales_chart.png showing monthly trend'],
                    verify: ['Run script on sample data', 'Verify 3 files generated', 'Chart displays 12 months', 'Numbers match manual calculation']
                },
                refactor: {
                    task: 'Refactor JavaScript function to use ES6+ features',
                    input: ['Legacy ES5 function with callbacks', 'Approximately 50 lines'],
                    constraints: ['Convert to ES6+ syntax', 'Use async/await instead of callbacks', 'Maintain exact same functionality', 'No breaking changes'],
                    output: ['Refactored function code', 'List of changes made', 'Migration notes'],
                    verify: ['All original tests pass', 'No behavior changes', 'Code is more readable']
                }
            };

            if (patterns[type]) {
                const pattern = patterns[type];
                document.getElementById('task').value = pattern.task;
                builder.setTask(pattern.task);
                
                pattern.input.forEach(item => addItem('input', item));
                pattern.constraints.forEach(item => addItem('constraint', item));
                pattern.output.forEach(item => addItem('output', item));
                pattern.verify.forEach(item => addItem('verify', item));
                
                buildPrompt();
            }
        }

        // Add item to list
        function addItem(type, value = null) {
            const input = document.getElementById(`${type}Item`);
            const list = document.getElementById(`${type}List`);
            const itemValue = value || input.value.trim();
            
            if (!itemValue) return;
            
            const item = document.createElement('div');
            item.className = 'item';
            item.innerHTML = `
                <span>${itemValue}</span>
                <button onclick="removeItem(this, '${type}')">√ó</button>
            `;
            list.appendChild(item);
            
            // Add to builder
            if (type === 'input') builder.addInput(itemValue);
            if (type === 'constraint') builder.addConstraint(itemValue);
            if (type === 'output') builder.addOutput(itemValue);
            if (type === 'verify') builder.addVerification(itemValue);
            
            if (!value) input.value = '';
        }

        // Remove item from list
        function removeItem(button, type) {
            button.parentElement.remove();
            rebuildFromUI();
        }

        // Rebuild builder from UI
        function rebuildFromUI() {
            builder.reset();
            builder.setTask(document.getElementById('task').value);
            
            document.querySelectorAll('#inputList .item span').forEach(el => {
                builder.addInput(el.textContent);
            });
            
            document.querySelectorAll('#constraintList .item span').forEach(el => {
                builder.addConstraint(el.textContent);
            });
            
            document.querySelectorAll('#outputList .item span').forEach(el => {
                builder.addOutput(el.textContent);
            });
            
            document.querySelectorAll('#verifyList .item span').forEach(el => {
                builder.addVerification(el.textContent);
            });
        }

        // Build prompt
        function buildPrompt() {
            try {
                rebuildFromUI();
                currentPromptText = builder.build({ format: 'text' });
                document.getElementById('promptOutput').textContent = currentPromptText;
                
                // Update metrics
                sessionMetrics.prompts++;
                sessionMetrics.tokens += builder.estimateTokens();
                updateMetrics();

                // Auto-save to history
                if (currentPromptText && builder.prompt.task) {
                    addToHistory();
                }

                // Show smart suggestions
                const suggestions = getSmartSuggestions();
                if (suggestions.length > 0 && document.getElementById('suggestionsPanel')) {
                    displaySuggestions(suggestions);
                }
            } catch (error) {
                alert('Error building prompt: ' + error.message);
            }
        }

        // Display smart suggestions
        function displaySuggestions(suggestions) {
            const panel = document.getElementById('suggestionsPanel');
            if (!panel || suggestions.length === 0) return;

            panel.style.display = 'block';
            const list = document.getElementById('suggestionsList');
            list.innerHTML = '';

            suggestions.slice(0, 5).forEach(suggestion => {
                const item = document.createElement('div');
                item.style.cssText = 'padding: 10px; margin: 5px 0; background: white; border-radius: 5px; cursor: pointer; border: 1px solid #dee2e6;';
                item.innerHTML = `
                    <strong>${suggestion.type.toUpperCase()}</strong>: ${suggestion.text}<br>
                    <small style="color: #6c757d;">${suggestion.reason}</small>
                `;
                item.onclick = () => {
                    applySuggestion(suggestion.type, suggestion.text);
                    item.style.opacity = '0.5';
                    item.style.pointerEvents = 'none';
                };
                list.appendChild(item);
            });
        }

        // Validate prompt
        function validatePrompt() {
            if (!currentPromptText) {
                alert('Please build a prompt first!');
                return;
            }
            
            const result = validator.validate(currentPromptText);
            
            // Show score section
            document.getElementById('scoreSection').style.display = 'block';
            
            // Update scores
            document.getElementById('scoreNumber').textContent = result.overall.score;
            document.getElementById('scoreGrade').textContent = result.overall.grade;
            
            document.getElementById('scoreK').textContent = result.principles.keepSimple.score;
            document.getElementById('scoreE1').textContent = result.principles.easyVerify.score;
            document.getElementById('scoreR').textContent = result.principles.reproducible.score;
            document.getElementById('scoreN').textContent = result.principles.narrowScope.score;
            document.getElementById('scoreE2').textContent = result.principles.explicitConstraints.score;
            document.getElementById('scoreL').textContent = result.principles.logicalStructure.score;
            
            // Show recommendations
            if (result.recommendations.length > 0) {
                document.getElementById('recommendationsSection').style.display = 'block';
                const list = document.getElementById('recommendationsList');
                list.innerHTML = '';
                result.recommendations.forEach(rec => {
                    const li = document.createElement('li');
                    li.textContent = rec;
                    list.appendChild(li);
                });
            } else {
                document.getElementById('recommendationsSection').style.display = 'none';
            }
            
            // Update metrics
            sessionMetrics.scores.push(result.overall.score);
            updateMetrics();
            
            // Scroll to results
            document.getElementById('scoreSection').scrollIntoView({ behavior: 'smooth' });
        }

        // Copy prompt
        function copyPrompt() {
            if (!currentPromptText) {
                alert('Please build a prompt first!');
                return;
            }
            
            navigator.clipboard.writeText(currentPromptText).then(() => {
                alert('‚úÖ Prompt copied to clipboard!');
            }).catch(err => {
                alert('Failed to copy: ' + err);
            });
        }

        // Export prompt as JSON
        function exportPrompt() {
            if (!currentPromptText) {
                alert('Please build a prompt first!');
                return;
            }
            
            const data = {
                task: builder.prompt.task,
                input: builder.prompt.input,
                constraints: builder.prompt.constraints,
                output: builder.prompt.output,
                verify: builder.prompt.verify,
                promptText: currentPromptText,
                estimatedTokens: builder.estimateTokens(),
                timestamp: new Date().toISOString()
            };
            
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'kernel-prompt.json';
            a.click();
            URL.revokeObjectURL(url);
        }

        // Reset builder
        function resetBuilder() {
            builder.reset();
            document.getElementById('task').value = '';
            document.getElementById('inputList').innerHTML = '';
            document.getElementById('constraintList').innerHTML = '';
            document.getElementById('outputList').innerHTML = '';
            document.getElementById('verifyList').innerHTML = '';
            document.getElementById('promptOutput').textContent = 'Your KERNEL-formatted prompt will appear here...';
            document.getElementById('scoreSection').style.display = 'none';
            currentPromptText = '';
        }

        // Update metrics display
        function updateMetrics() {
            document.getElementById('metricPrompts').textContent = sessionMetrics.prompts;
            document.getElementById('metricTokens').textContent = sessionMetrics.tokens.toLocaleString();
            
            if (sessionMetrics.scores.length > 0) {
                const avg = sessionMetrics.scores.reduce((a, b) => a + b, 0) / sessionMetrics.scores.length;
                const best = Math.max(...sessionMetrics.scores);
                document.getElementById('metricAvgScore').textContent = avg.toFixed(1);
                document.getElementById('metricBest').textContent = best;
            }

            // Update history display
            updateHistoryDisplay();
        }

        // Update history display
        function updateHistoryDisplay() {
            const historyList = document.getElementById('historyList');
            if (!historyList) return;

            if (promptHistory.length === 0) {
                historyList.innerHTML = '<p style="color: #6c757d; text-align: center; padding: 20px;">No prompts yet. Build your first prompt!</p>';
                return;
            }

            historyList.innerHTML = '';
            promptHistory.slice(0, 10).forEach(item => {
                const div = document.createElement('div');
                div.style.cssText = 'padding: 12px; margin: 8px 0; background: white; border-radius: 6px; cursor: pointer; border: 1px solid #dee2e6; transition: all 0.2s;';
                div.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div style="flex: 1;">
                            <strong>${item.task.substring(0, 60)}${item.task.length > 60 ? '...' : ''}</strong><br>
                            <small style="color: #6c757d;">
                                Score: ${item.score} | 
                                ${new Date(item.timestamp).toLocaleString()}
                            </small>
                        </div>
                        <button class="btn btn-secondary" style="padding: 6px 12px; font-size: 0.9em;" onclick="event.stopPropagation(); loadFromHistory(${item.id})">Load</button>
                    </div>
                `;
                div.onmouseover = () => div.style.borderColor = '#667eea';
                div.onmouseout = () => div.style.borderColor = '#dee2e6';
                div.onclick = () => loadFromHistory(item.id);
                historyList.appendChild(div);
            });
        }

        // Event listeners for Enter key
        ['inputItem', 'constraintItem', 'outputItem', 'verifyItem'].forEach(id => {
            document.getElementById(id).addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    const type = id.replace('Item', '');
                    addItem(type);
                }
            });
        });

        // Auto-build on task change
        document.getElementById('task').addEventListener('blur', () => {
            if (document.getElementById('task').value.trim()) {
                buildPrompt();
            }
        });

        // Initialize
        console.log('üéØ KERNEL Playground loaded');
        console.log('üìñ Documentation: KERNEL_FRAMEWORK.md');
        
        // Load saved state
        loadSavedState();
        
        // Update displays
        updateHistoryDisplay();
    </script>
    <script src="/js/universal-utilities.js"></script>
</body>
</html>
